---
layout:     post
title:      2,程序的机器级表示
subtitle:   汇编指令和C/C++
date:       2018-11-23
author:     chensong
header-img: img/post-bg-cmd.jpg
catalog: 	 true
tags:
    - 深入理解计算机系统(原书第三版3)
---

## 前言

C/C++程序在编译后指令

## 正文


### 一, 编译使用命令

#### 1, 汇编命令

example

```
gcc -Og -S main.c
 
```

#### 2, intel 汇编指令

```
gcc -Og -S -masm=intel  main.c
```

#### 3, 反编译 命令

```
 objdump -d ${main}
```

### 二, 汇编指令

#### 1,  mov 指令的使用

C语言

```

void decode(long *xp, long *yp, long *zp)
{
        long x = *xp;
        long y = *yp;
        long z = *zp;
        *yp = x;
        *zp = y;
        *xp = z;
}
```


编译汇编
```
_Z6decodePlS_S_:
.LFB989:
        .cfi_startproc
        movq    (%rdi), %r8
        movq    (%rsi), %rcx
        movq    (%rdx), %rax
        movq    %r8, (%rsi)
        movq    %rcx, (%rdx)
        movq    %rax, (%rdi)
        ret
        .cfi_endproc
.LFE989
```



#### 2, 加载有效地址

指令leaq 实际上是movq的指令变形

```
long scale(long x, long y, long z)
{
		long t = x + 4 * y + 12 * z;
        //long t =  5 * x + 2 * y  + 8 * z; // example
		
        return t;
}
```

```
// x in %rdi, y in %rsi, z in %rdx

_Z5scalelll:
.LFB990:
        .cfi_startproc
        leaq    (%rdi,%rsi,4), %rcx		// x + 4 * y		
        leaq    (%rdx,%rdx,2), %rax		// z + 2 * z = 3 * z
        leaq    (%rax,%rdx,4), %rax		// (x + 4 * y) + 4 * ( 3 * z) = x + 4 * y + 12 * z
		//salq    $2, %rax
        //addq    %rcx, %rax
        ret
        .cfi_endproc
// ----------------------example-------

//_Z5scalelll:
//.LFB990:
//       .cfi_startproc
//       leaq    (%rdi,%rdi,4), %rax
//       leaq    (%rax,%rsi,2), %rax
//       leaq    (%rax,%rdx,8), %rax
//       ret
//       .cfi_endproc


```


#### 3, 位操作

```
long arith(long x, long y, long z)
{
        long t1 = x ^ y;
        long t2 = z * 48;
        long t3 = t1 & 0x0F0F0F0F;
        long t4 = t2 - t3;
        return t4;
}
```

```
// long arith (long x, long y, long z)
// x in %rdi , y in %rsi , z in %rdx

_Z5arithlll:
.LFB991:
        .cfi_startproc
        xorq    %rsi, %rdi				// t1 = x ^ y;
        leaq    (%rdx,%rdx,2), %rax		// 3 * z;
        salq    $4, %rax				// t2 = 16 * (3 * z) = 48 * z
        andl    $252645135, %edi		// t3 = t1 & 0X0F0F0F0F;
        subq    %rdi, %rax				// return t2 - t3
        ret
        .cfi_endproc
```



## 结语

